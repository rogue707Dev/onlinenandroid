echo "##########################################"
echo "Online Nandroid Backup v3.1"
echo "* A tool to perform a nandroid backup"
echo "  without booting into recovery. It can"
echo "  be run via adb shell or terminal"
echo "  emulator in Android, thus allowing"
echo "  you to do a live nandroid backup"
echo "  within Android."
echo "* This tool backups /system , /data , "
echo "  /cache , .android_secure & sd-ext"
echo "  partitions."
echo "* It is fully compatible with nandroid."
echo "* Type 'onandroid --help' for usage"
echo "  instructions."
echo "* Created by Ameer Dawood"
echo "##########################################"
echo ""

# Define constants
path="/sdcard/clockworkmod/backup"
safety=7
name="none"
tz="u"
req_power=10
sdcard_temp_mount="/mnt/sdcard4nandroid"

# Process arguments
if [ $# -gt 0 ]; then
	if [ $1 == "--help" ]; then
		# Display usage instructions
		clear
		echo ""
		echo "Usage: onandroid [OPTIONS] [NAME]"
		echo ""
		echo "Performs a nandroid backup with the NAME provided, or a default backup name consisting of the current date and time"
		echo ""
		echo "		-h		Generate backup name with phone timezone"
		echo "		-u		Generate backup name with UTC time (default)"
		echo ""
		exit 0
	elif [ $1 == "-h" ]; then
		# Set timezone to home/phone timezone
		tz="h"
		if [ $# -gt 1 ]; then
			echo "`date +%T` Custom backup name not allowed with timezone modifier! Continuing with default backup name!"
		fi
	elif [ $1 == "-u" ]; then
		# Set timezone to UTC
		tz="u"
		if [ $# -gt 1 ]; then
			echo "`date +%T` Custom backup name not allowed with timezone modifier! Continuing with default backup name!"
		fi
	else
		if [ $# -gt 1 ]; then
			echo "`date +%T` Spaces not allowed in backup name! Continuing with default backup name!"
		else
			# Grab custom backup name
			name=$1
		fi
	fi
fi

# Set default backup name (with date)
if [ $tz == "h" ]; then
	def_name=`date +%Y-%m-%d.%H.%M.%S`
else
	def_name=`date -u +%Y-%m-%d.%H.%M.%S`
fi

# Set backup name to default if backup name was not provided
if [ $name == "none" ]; then
	name=$def_name
fi

# Start timer
start_time=`date +%s`

# Analyse power status
echo "`date +%T` Analysing power..."
if [ -f /sys/class/power_supply/bq27520/capacity ]; then
	rem_power=`cat /sys/class/power_supply/bq27520/capacity`
	if [ `cat /sys/class/power_supply/ac/online` == "1" ]; then
		rem_power=100
	fi
else
	rem_power=100
	echo "`date +%T` Unable to check power status! Taking a chance here..."
fi

# Check if power is sufficient
if [ $rem_power -gt $req_power ]; then
	echo "`date +%T` Required level of power available! Continuing..."
else
	echo "`date +%T` Required level of power not available! Exiting..."
	exit 1
fi

# Check if SD card is mounted
echo "`date +%T` Searching for SD card..."
is_sdcard_mounted=`mount | grep "sdcard.*vfat" | cut -d ' ' -f 1`
if [ "$is_sdcard_mounted" == "" ]; then
	echo "`date +%T` SD card not found! Exiting..."
	exit 1
else
	echo "`date +%T` SD card found! Continuing..."
fi

# Check for root permissions
echo "`date +%T` Checking for root permissions..."
uid=`id -u`
if [ "$uid" == "0" ]; then
	echo "`date +%T` Root permissions aquired! Continuing..."
else
	echo "`date +%T` Could not aquire root permissions! Exiting..."
	exit 1
fi

# Check for required tools
echo "`date +%T` Checking for required tools..."
mkyaffs2image=`which mkyaffs2image`
if [ "$mkyaffs2image" == "" ]; then
	echo "`date +%T` Error: mkyaffs2image not found in path! Exiting..."
	exit 1
fi
md5sum=`which md5sum`
if [ "$md5sum" == "" ]; then
	echo "`date +%T` Error: md5sum not found in path! Exiting..."
	exit 1
fi
tar==`which tar`
if [ "$tar" == "" ]; then
	echo "`date +%T` Error: tar not found in path! Exiting..."
	exit 1
fi
echo "`date +%T` All required tools available! Continuing..."

# Disk space check (in MB)
echo "`date +%T` Checking disk space..."

# /system partition size
entry=`df -m /system | tail -1`
u_system=`echo $entry | cut -d' ' -f 3 | cut -d '%' -f 1`

# /data partition size
entry=`df -m /data | tail -1`
u_data=`echo $entry | cut -d' ' -f 3 | cut -d '%' -f 1`

# /cache partition size
entry=`df -m /cache | tail -1`
u_cache=`echo $entry | cut -d' ' -f 3 | cut -d '%' -f 1`

# .android_secure partition size
# Mount sdcard into a temporary location for accessing .android_secure partition
sdcard_vold_id=`mount | grep "sdcard.*vfat" | cut -d ' ' -f 1`
mount -o remount,rw /
mkdir $sdcard_temp_mount
mount $sdcard_vold_id $sdcard_temp_mount
cd $sdcard_temp_mount
u_as=`du -m .android_secure | cut -f 1`

# sd-ext partition size
# Check if sd-ext is mounted
is_sdext_mounted=`mount | grep "ext.*ext" | cut -d ' ' -f 1`
if [ "$is_sdext_mounted" == "" ]; then
	sdext_exists=0
else
	sdext_exists=1
fi
if [ $sdext_exists == 1 ]; then
	# Determine mount command's output format
	if [ `mount | grep "ext.*ext" | cut -d ' ' -f 2` == "on" ]; then
		extv=`mount | grep "ext.*ext" | cut -d ' ' -f 5`
		extd=`mount | grep "ext.*ext" | cut -d ' ' -f 3 | cut -d '/' -f 2`
		extm=`mount | grep "ext.*ext" | cut -d ' ' -f 3`
	else
		extv=`mount | grep "ext.*ext" | cut -d ' ' -f 3`
		extd=`mount | grep "ext.*ext" | cut -d ' ' -f 2 | cut -d '/' -f 2`
		extm=`mount | grep "ext.*ext" | cut -d ' ' -f 2`
	fi
	# Grab sd-ext mount point
	entry=`df -m $extm | tail -1`
	u_ext=`echo $entry | cut -d ' ' -f 3 | cut -d '%' -f 1`
else
	u_ext=0
fi

# Required space calculation
req_space=`expr $u_system + $u_data + $u_cache + $u_as + $u_ext + $safety`

# Available space calculation
entry=`df -m /mnt/sdcard | tail -1`
freespace=`echo $entry | cut -d ' ' -f 3 | cut -d '%' -f 1`

# Announce available space and required space
echo "`date +%T` SD Card Free Space: $freespace MB"
echo "`date +%T` Required Space: $req_space MB"
if [ $freespace -lt $req_space ]; then
	echo "`date +%T` Not enough disk space! Exiting..."
	exit 1
else
	echo "`date +%T` Necessary disk space available! Continuing..."
fi

# Change to backup directory
mkdir -p $path
cd $path

# Create directory for backup
echo "`date +%T` Creating backup directory..."
if [ ! -d $name ]; then 
	mkdir -p -- $name
	if [ ! -d $name ]; then 
		echo "`date +%T` Error: Cannot create $name"
		exit 1
	fi
else
	echo "`date +%T` Error: $name already exists! Exiting..."
	exit 1
fi
touch -- $name/.nandroidwritable
if [ ! -e $name/.nandroidwritable ]; then
	echo "`date +%T` Error: Cannot write to $name ! Exiting..."
	exit 1
fi
rm -- $name/.nandroidwritable

echo "`date +%T` Backing up to $path/$name"
echo "`date +%T` Opening backup directory..."
cd -- $name

# Backup system
echo -e "`date +%T` Backing up /system...\c"
mkyaffs2image /system system.yaffs2.img &
while [ `pidof mkyaffs2image` ]; do
	echo -n "."
	sleep 2
done
echo ""

# Backup data
echo -e "`date +%T` Backing up /data...\c"
mkyaffs2image /data data.yaffs2.img &
while [ `pidof mkyaffs2image` ]; do
	echo -n "."
	sleep 2
done
echo ""

# Backup cache
echo -e "`date +%T` Backing up /cache...\c"
mkyaffs2image /cache cache.yaffs2.img &
while [ `pidof mkyaffs2image` ]; do
	echo -n "."
	sleep 2
done
echo ""

# Backup .android_secure
echo -e "`date +%T` Backing up .android_secure...\c"
cd /mnt/sdcard4nandroid
tar -cf $path/$name/.android_secure.vfat.tar .android_secure &
while [ `pidof tar` ]; do
	echo -n "."
	sleep 2
done
echo ""

# Unmount temporary sdcard mount as .android_secure backup is complete
# Wait 2 seconds before we umount device
sleep 2
umount -l $sdcard_temp_mount
rmdir $sdcard_temp_mount
mount -o remount,ro /

# Backup sd-ext
if [ $sdext_exists == 1 ]; then
	# Grab ext version
	echo -e "`date +%T` Backing up sd-ext...\c"
	cd $extm
	cd ..
	tar -cf $path/$name/sd-ext.$extv.tar $extd &
	while [ `pidof tar` ]; do
		echo -n "."
		sleep 2
	done
	echo ""
else
	echo "`date +%T` sd-ext not found! Skipping backup of sd-ext!"
fi

# Generate md5
echo -e "`date +%T` Generating md5sum...\c"
cd $path/$name
md5sum .android_secure.vfat.tar * > nandroid.md5 &
while [ `pidof md5sum` ]; do
	echo -n "."
	sleep 2
done
echo ""

# End timer
end_time=`date +%s`
elapsed=`expr $end_time - $start_time`

# Calculate elapsed time and Announce
e_min=`expr $elapsed / 60`
e_sec=`expr $e_min \* 60`
e_sec=`expr $elapsed - $e_sec`
echo "`date +%T` Online Nandroid Backup Completed in $e_min minutes $e_sec seconds!"
