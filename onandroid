#### Define constants
version="7.52"
blobsdir="/clockworkmod/blobs"
tz="utc"
req_power=10
all_partitions="mbrwlsdcteoufpax"
sdcard_temp_mount="/mnt/sdcard4nandroid"
sdext_temp_mount="/mnt/sdext4nandroid"
custbkp_temp_mount="/mnt/custbkp4nandroid"
logpath="/data/local/tmp"
logfile="$logpath/onandroid.log"
pidfile="$logpath/onandroid.pid"

#### Define exit codes (returned upon exit due to an error)
err_noroot=65 # Could not acquire root permissions
err_nobatt=66 # Sufficient battery not available
err_bbvless=67 # BusyBox version less than 1.20 found
err_nosdcard=68 # SD card not found
err_killsig=69 # Killed by exit/kill signal
err_nomkyaffs=70 # mkyaffs2image not found in path
err_nodedupe=71 # dedupe not found in path
err_nomd5sum=72 # md5sum not found in path
err_notar=73 # tar not found in path
err_nodd=74 # dd not found in path
err_nobusybox=75 # busybox not found in path
err_cntcdpath=80 # Could not change to backup path
err_cntmkname=81 # Cannot create backup directory
err_cntrmname=82 # Cannot delete backup directory
err_nameexist=83 # Backup name already exists
err_cntwrname=84 # Cannot write to backup directory
err_cntwrblobs=85 # Cannot write to blobs directory
err_nospace=86 # Not enough disk space
err_cntcdname=87 # Could not change to backup directory

#### Logging function
if [ ! -d $logpath ]; then
	busybox mkdir -p $logpath
fi
logmsg(){
	message="$*"
	dtime=`busybox date +%T`
	busybox echo -e "$dtime $message"
	busybox echo -E "$dtime $message" >>$logfile
	if [ "`busybox which log`" != "" ]; then
		log -p i -t onandroid "$message"
	fi
}

#### Error logging function (for detailed error logs)
logerror(){
	busybox echo "$1" >>$logfile
	busybox echo "$2" >>$logfile
	if [ "`busybox which log`" != "" ]; then
		log -p i -t onandroid "$1"
		log -p i -t onandroid "$2"
	fi
}

#### Cleanup function (Unmount temporary sdcard mount & remount root as ro)
cleanup(){
	if [ "$as_parent" != "" -a "`busybox echo $adv | busybox grep 'a'`" != "" ]; then
		busybox umount -lf $sdcard_temp_mount
		busybox rmdir $sdcard_temp_mount
	fi
	if [ "$sdext_mount" != "" -a "`busybox echo $adv | busybox grep 'x'`" != "" ]; then
		busybox umount -lf $sdext_temp_mount/sd-ext
		busybox rmdir $sdext_temp_mount/sd-ext
		busybox rmdir $sdext_temp_mount
	fi
	if [ "$custbkp_fs" != "" -a "`busybox echo $adv | busybox grep 'u'`" != "" ]; then
		busybox umount -lf $custbkp_temp_mount/boot
		busybox rmdir $custbkp_temp_mount/boot
		busybox rmdir $custbkp_temp_mount
	fi
	if [ "$flexrom_hinted" == 1 ]; then
		busybox umount -lf /flexrom
		busybox rmdir /flexrom
		busybox mv -f /flexrom_bkp /flexrom
	fi
	if [ "$as_parent" -o "$sdext_mount" != "" -o "$custbkp_fs" != "" -o "$flexrom_hinted" == 1 ]; then
		busybox mount -o remount,ro / 2> /dev/null
	fi
}

#### Kill All Tools function (used while trapping exits)
killalltools(){
	busybox killall busybox 2> /dev/null
	busybox killall mkyaffs2image 2> /dev/null
	busybox killall dedupe 2> /dev/null
}

#### Garbage Collect function (used for incremental backups)
garbagecollect(){
	logmsg "Freeing Space...\c"
	dedupe gc $blobsdir $(busybox find $path -name "*.dup") &
	while [ `busybox pidof dedupe` ]; do
		busybox echo -n "."
		busybox sleep 2
	done
	busybox echo ""
}

#### Usage instructions
usage(){
	busybox echo "$1"
	busybox echo "Online Nandroid v$version by Ameer Dawood"
	busybox echo ""
	busybox echo "Usage: onandroid [options]"
	busybox echo ""
	busybox echo "Options:"
	busybox echo "  -h, --help                    display this help message and exit"
	busybox echo "  -ah, --advanced-help          display help for advanced backup mode"
	busybox echo "  -v, --version                 display version number and exit"
	busybox echo "  -p, --phone                   generate backup name with phone timezone"
	busybox echo "  -u, --utc                     generate backup name with UTC time (default)"
	busybox echo "  -i, --incremental             CWM6 style incremental backup mode"
	busybox echo "  -a, --advanced PARTITIONS     advanced / selective backup mode"
	busybox echo "  -l, --split                   split backup mode (CWM 6+ only)"
	busybox echo "  -o, --old                     good old backup mode (default)"
	busybox echo "  -gc, --garbage-collect        run garbage collect mode"
	busybox echo "  -w, --twrp                    TWRP backup mode"
	busybox echo "  -me, --md5-enable             enable md5 generation (for TWRP only)"
	busybox echo "  -md, --md5-disable            disable md5 generation (for TWRP only)"
	busybox echo "  -ce, --compression-enable     enable compression (for TWRP only)"
	busybox echo "  -cd, --compression-disable    disable compression (for TWRP only)"
	busybox echo "  -c, --custom NAME             specify a custom backup name"
	busybox echo "  -s, --storage MEDIA           specify an alternate storage media to backup"
	busybox echo "  -e, --sd-ext-path PATH        specify path to sd-ext partition"
	busybox echo "  -r, --replace                 replace backup with same name"
	busybox echo ""
	exit 0
}

#### Mapping for advanced backup
advmapping(){
	busybox echo "Online Nandroid v$version by Ameer Dawood"
	busybox echo ""
	busybox echo "Usage: onandroid -a <partitions>"
	busybox echo ""
	busybox echo "<partitions>"
	busybox echo "  m: mmcblk0_start (for Acer devices)"
	busybox echo "  b: boot"
	busybox echo "  r: recovery"
	busybox echo "  w: wimax (for Samsung devices)"
	busybox echo "  l: appslog (for HTC and Sony (Ericsson) devices)"
	busybox echo "  s: system"
	busybox echo "  d: data"
	busybox echo "  c: cache"
	busybox echo "  t: datadata (for Samsung devices)"
	busybox echo "  e: efs (for Samsung devices)"
	busybox echo "  o: preload (for Samsung devices)"
	busybox echo "  u: .cust_backup (for Huawei devices)"
	busybox echo "  f: flexrom (for Acer devices)"
	busybox echo "  p: boot (for HP Touchpad)"
	busybox echo "  i: (cp)uid (for Acer devices)"
	busybox echo "  a: android_secure"
	busybox echo "  x: sd-ext"
	busybox echo ""
	exit 0
}

#### Progress status function
progress(){
	if [ "$progress_style" == "dot" ]; then
		busybox echo -n "."
	else
		if [ -f $path/$name/$1 ] && [ "`busybox echo $full_size | busybox egrep "^[0-9]+$"`" ]; then
			copied=`busybox stat -t "$path/$name/$1" | busybox awk '{print $2}'`
			copied=`busybox expr $copied / 1048576` 2> /dev/null
			pct=`busybox expr \( 100 \* $copied \) / $full_size` 2> /dev/null
			if [ "`busybox echo $pct | busybox egrep "^[0-9]+$"`" ]; then
				if [ "$pct" -gt 99 ]; then
					pct=99
				elif [ "$pct" -lt 10 ]; then
					busybox echo -en "$pct%\b\b"
				else
					busybox echo -en "$pct%\b\b\b"
				fi
			else
				busybox echo -en " +\b\b"
				busybox sleep 2
				busybox echo -en " x\b\b"
			fi
		else
			busybox echo -en " +\b\b"
			busybox sleep 2
			busybox echo -en " x\b\b"
		fi
	fi
}

#### Progress done function
progress_done(){
 	if [ "$progress_style" == "dot" ]; then
		busybox echo -n "."
	else
		busybox echo -en "100%\b\b\b\b"
	fi
}

#### Backup Function - Disk Dump
nandroid_dd(){
	part_name=$1 # Name of partition.Used only for display.
	part_fname=$2 # Backup file name.
	part_dev=$3 # Device name.
	part_id=$4 # Partition identification letter (used in advanced backup mode).
	part_size=$5 # Partition size.
	part_bs=$6 # bs value for dd.
	part_count=$7 # count value for dd. Pass "" (empty string) to omit count argument.
	part_start=$8 # skip value for dd. Pass "" (empty string) to to omit skip value.
	part_iscommon=$9 # Is partition common among all android?
	# Usage: nandroid_dd $part_name $part_fname $part_dev $part_id $part_size $part_bs $part_count $part_start $part_iscommon

	if [ "`busybox echo $adv | busybox grep $part_id`" != "" ]; then
		if [ $part_type == "not_found" -o "$part_dev" == "" ]; then
			if [ "$part_iscommon" == "yes" ]; then
				logmsg "/$part_name not found! Skipping backup of /$part_name!"
			fi
		else
			logmsg "Backing up /$part_name...\c"
			if [ `busybox echo "$part_size" | busybox egrep "^[0-9]+$"` ]; then
				full_size=$part_size
			else
				full_size=-1
			fi
			if [ "$part_start" == "" ]; then
				busybox dd if=$part_path/$part_dev of=$path/$name/$part_fname.$img_ext bs=$part_bs 2> /dev/null &
				while [ `busybox ps | busybox grep "busybox dd" | busybox grep -v "busybox grep busybox dd" | busybox awk '{print $1}'` ]; do
					progress $part_fname.$img_ext
					busybox sleep 2
				done
				progress_done
				busybox echo ""
			else
				part_start=`busybox expr $part_start / $part_bs`
				part_count=`busybox expr $part_count / $part_bs`
				busybox dd if=$part_path/$part_dev of=$path/$name/$part_fname.$img_ext bs=$part_bs skip=$part_start count=$part_count 2> /dev/null &
				while [ `busybox ps | busybox grep "busybox dd" | busybox grep -v "busybox grep busybox dd" | busybox awk '{print $1}'` ]; do
					progress $part_fname.$img_ext
					busybox sleep 2
				done
				progress_done
				busybox echo ""
			fi
		fi
	fi
}

#### Backup Function - Filesystems
nandroid_fs(){
	part_name=$1 # Name of partition.Used only for display.
	part_fname=$2 # Backup file name.
	part_id=$3 # Partition identification letter (used in advanced backup mode).
	part_mount=$4 # Partition mount point.
	part_mountdir=$5 # Directory name of mount point.
	part_fs=$6 # Filesystem type.
	part_size=$7 # Partition size.
	part_excludes=$8 # Excludes for tar
	part_excludes_dedupe=$9 # Excludes for dedupe
	part_iscommon=$10 # Is partition common among all android?
	# Usage: nandroid_fs $part_name $part_fname $part_id $part_mount $part_mountdir $part_fs $part_size $part_excludes $part_excludes_dedupe $part_iscommon

	if [ "`busybox echo $adv | busybox grep $part_id`" != "" ]; then
		if [ "$part_fs" != "" ]; then
			if [ "$backup_style" == "twrp" ]; then
				if [ "$part_excludes" != "" ]; then
					part_m="`busybox echo $part_mount | busybox sed s/'^\/'/''/g`"
					part_excludes="`busybox echo $part_excludes | busybox sed s/$part_m/'.'/g`"
				fi
				logmsg "Backing up /$part_name...\c"
				cd $part_mount
				if [ `busybox echo "$part_size" | busybox egrep "^[0-9]+$"` ]; then
					full_size=$part_size
				else
					full_size=-1
				fi
				if [ "$compress_backup" == "no" ]; then
					busybox tar -cf $path/$name/$part_fname.$part_fs.win $part_excludes $part_mountdir ./* > /dev/null 2>&1 &
					while [ `busybox ps | busybox grep "busybox tar" | busybox grep -v "busybox grep busybox tar" | busybox awk '{print $1}'` ]; do
						progress $part_fname.$part_fs.win
						busybox sleep 2
					done
				else
					busybox tar -czf $path/$name/$part_fname.$part_fs.win $part_excludes $part_mountdir ./* > /dev/null 2>&1 &
					while [ `busybox ps | busybox grep "busybox tar" | busybox grep -v "busybox grep busybox tar" | busybox awk '{print $1}'` ]; do
						progress $part_fname.$part_fs.win
						busybox sleep 2
					done
				fi
				if [ ! -f $path/$name/$part_fname.$part_fs.win ]; then
					busybox tar -cZf $path/$name/$part_fname.$part_fs.win $part_excludes $part_mountdir ./* > /dev/null 2>&1 &
					while [ `busybox ps | busybox grep "busybox tar" | busybox grep -v "busybox grep busybox tar" | busybox awk '{print $1}'` ]; do
						progress $part_fname.$part_fs.win
						busybox sleep 2
					done
				fi
				progress_done
				busybox echo ""
			else
				if [ "$part_fs" == "yaffs2" -a "$yaffs_override" != "yes" ]; then
					logmsg "Backing up /$part_name...\c"
					if [ `busybox echo "$part_size" | busybox egrep "^[0-9]+$"` ]; then
						full_size=$part_size
					else
						full_size=-1
					fi
					mkyaffs2image $part_mount $part_fname.$part_fs.img &
					while [ `busybox pidof mkyaffs2image` ]; do
						progress $part_fname.$part_fs.img
						busybox sleep 2
					done
					progress_done
					busybox echo ""
				else
					cd $part_mount/..
					logmsg "Backing up /$part_name...\c"
					if [ "$backup_style" == "incremental" ]; then
						dedupe c $part_mountdir $blobsdir $path/$name/$part_fname.$part_fs.dup $part_excludes_dedupe > /dev/null 2>&1 &
						while [ `busybox pidof dedupe` ]; do
							progress dedupe_$part_fname
							busybox sleep 2
						done
						progress_done
						busybox echo ""
					elif [ "$backup_style" == "tarsplit" ]; then
						busybox touch $path/$name/$part_fname.$part_fs.tar
						busybox tar -c $part_excludes $part_mountdir 2> /dev/null | split -a 1 -b 1000000000 /proc/self/fd/0 $path/$name/$part_fname.$part_fs.tar. > /dev/null 2>&1 &
						while [ `busybox ps | busybox grep "busybox tar" | busybox grep -v "busybox grep busybox tar" | busybox awk '{print $1}'` ]; do
							progress tarsplit_$part_fname
							busybox sleep 2
						done
						progress_done
						busybox echo ""
					else
						if [ `busybox echo "$part_size" | busybox egrep "^[0-9]+$"` ]; then
							full_size=$part_size
						else
							full_size=-1
						fi
						busybox tar -cf $path/$name/$part_fname.$part_fs.tar $part_excludes $part_mountdir > /dev/null 2>&1 &
						while [ `busybox ps | busybox grep "busybox tar" | busybox grep -v "busybox grep busybox tar" | busybox awk '{print $1}'` ]; do
							progress $part_fname.$part_fs.tar
							busybox sleep 2
						done
						progress_done
						busybox echo ""
					fi
				fi
			fi
		else
			if [ "$part_iscommon" == "yes" ]; then
				logmsg "/$part_name not found! Skipping backup of /$part_name!"
			fi
		fi
	fi
}

#### Rnfgre Rtt Trarengbe shapgvba
rtt(){
	rtt="Gur Fxlarg Shaqvat Ovyy vf cnffrq. Gur flfgrz tbrf ba-yvar Nhthfg 4gu, 1997. Uhzna qrpvfvbaf ner erzbirq sebz fgengrtvp qrsrafr. Fxlarg ortvaf gb yrnea ng n trbzrgevp engr. Vg orpbzrf frys-njner ng 2:14 NZ Rnfgrea gvzr, Nhthfg 29gu. Va n cnavp, gurl gel gb chyy gur cyht."
	busybox echo ""
	busybox echo $rtt | busybox tr 'a-mn-zA-MN-Z' 'n-za-mN-ZA-M'
	busybox echo ""
	exit 0
}

#### Output PID
busybox echo "$$" >$pidfile

#### Process arguments
arglist=$@
argn=0
for arg in $arglist; do
	argn=`busybox expr $argn + 1`
	if [ "$arg" == "-h" ] || [ "$arg" == "--help" ]; then
		# Display usage instructions
		usage
	elif [ "$arg" == "-ah" ] || [ "$arg" == "--advanced-help" ]; then
		# Display partition mapping for advanced backup
		advmapping
	elif [ "$arg" == "-v" ] || [ "$arg" == "--version" ]; then
		busybox echo "$version"
		exit 0
	elif [ "$arg" == "-c" ] || [ "$arg" == "--custom" ]; then
		# Grab custom backup name
		name_pos=`busybox expr $argn + 1`
		eval "name=\$$name_pos"
		if [ ! "$name" ]; then
			# Prompt for backup name
			logmsg "Enter backup name: \c"
			read name
		fi
	elif [ "$arg" == "-s" ] || [ "$arg" == "--storage" ]; then
		# Grab storage path
		storage_pos=`busybox expr $argn + 1`
		eval "storage=\$$storage_pos"
		if [ ! "$storage" ]; then
			# Prompt for storage path
			logmsg "Enter storage path: \c"
			read storage
		fi
	elif [ "$arg" == "-e" ] || [ "$arg" == "--sd-ext-path" ]; then
		# Grab sd-ext path
		sdext_pos=`busybox expr $argn + 1`
		eval "sdextdir=\$$sdext_pos"
		if [ ! "$sdextdir" ]; then
			# Prompt for sd-ext path
			logmsg "Enter sd-ext path: \c"
			read sdextdir
		fi
	elif [ "$arg" == "-a" ] || [ "$arg" == "--advanced" ]; then
		advbkp_mode="run"
		# Grab partitions to backup
		adv_pos=`busybox expr $argn + 1`
		eval "adv=\$$adv_pos"
		if [ ! "$adv" ]; then
			# Prompt for partitions
			logmsg "Enter partitions to backup: \c"
			read adv
		fi
		# Show partition mapping if partition letters include an "h"
		if [ "`busybox echo $adv | busybox grep 'h'`" ]; then
			advmapping
		fi
	elif [ "$arg" == "-p" ] || [ "$arg" == "--phone" ]; then
		# Set timezone to phone timezone
		tz="phone"
	elif [ "$arg" == "-u" ] || [ "$arg" == "--utc" ]; then
		# Set timezone to UTC
		tz="utc"
	elif [ "$arg" == "-o" ] || [ "$arg" == "--old" ]; then
		backup_style="old"
	elif [ "$arg" == "-i" ] || [ "$arg" == "--incremental" ]; then
		backup_style="incremental"
	elif [ "$arg" == "-w" ] || [ "$arg" == "--twrp" ]; then
		backup_style="twrp"
	elif [ "$arg" == "-me" ] || [ "$arg" == "--md5-enable" ]; then
		generate_md5="yes"
	elif [ "$arg" == "-md" ] || [ "$arg" == "--md5-disable" ]; then
		generate_md5="no"
	elif [ "$arg" == "-ce" ] || [ "$arg" == "--compression-enable" ]; then
		compress_backup="yes"
	elif [ "$arg" == "-cd" ] || [ "$arg" == "--compression-disable" ]; then
		compress_backup="no"
	elif [ "$arg" == "-l" ] || [ "$arg" == "--split" ]; then
		backup_style="tarsplit"
	elif [ "$arg" == "-gc" ] || [ "$arg" == "--garbage-collect" ]; then
		backup_style="gc"
	elif [ "$arg" == "-r" ] || [ "$arg" == "--replace" ]; then
		replace_backup="yes"
	elif [ "$arg" == "-t" ] || [ "$arg" == "--sbin-last" ]; then
		export PATH=`echo $PATH | busybox sed s/':\/sbin:'/''/g | busybox sed s/'$'/':\/sbin'/g`
	elif [ "$arg" == "-pd" ] || [ "$arg" == "--progress-dot" ]; then
		progress_style="dot"
	elif [ "$arg" == "-pp" ] || [ "$arg" == "--progress-percent" ]; then
		progress_style="percent"
	elif [ "$arg" == "-nd" ] || [ "$arg" == "--notification-disable" ]; then
		notif_disable="yes"
	elif [ "$arg" == "-y" ] || [ "$arg" == "--yaffs-override" ]; then
		yaffs_override="yes"
	elif [ "$arg" == "-~" ] || [ "$arg" == "--rtt" ]; then
		rtt
	else
		argna=`busybox expr $argn - 1`
		eval "arga=\$$argna"
		if [ "$arga" == "-c" ] || [ "$arga" == "--custom" ] || [ "$arga" == "-s" ] || [ "$arga" == "--storage" ] || [ "$arga" == "-e" ] || [ "$arga" == "--sd-ext-path" ] || [ "$arga" == "-a" ] || [ "$arga" == "--advanced" ]; then
			# Nothing to do here
			# Do not argue with me that this is unnecessary. I have tried enough.
			null="null"
		else
			usage "One or more of the arguments passed are invalid!"
		fi
	fi
done

#### Empty the log file before we start
[ -f $logfile ] && busybox echo "" >$logfile

#### The header
busybox echo "##########################################"
busybox echo "Online Nandroid Backup v$version"
busybox echo "* A tool to perform a nandroid backup"
busybox echo "  without booting into recovery."
busybox echo "* It is fully compatible with nandroid."
busybox echo "* Type 'onandroid --help' for usage"
busybox echo "  instructions."
busybox echo "* Created by Ameer Dawood"
busybox echo "##########################################"
busybox echo ""

#### Spit version number, date, time and other technical info to log file
logerror "Online Nandroid v$version" "Started at `date`"
logerror "###########################" ""
logerror "Run with options: $*" ""
logerror "###########################" ""
logerror "BusyBox: `busybox | busybox grep "BusyBox v"`" ""
logerror "###########################" ""
logerror "File System Layout:" "`busybox mount | busybox grep -v "/mnt/asec/"`"
logerror "###########################" ""
logerror "Device Details:" "`busybox cat /system/build.prop | busybox grep "^ro.product." | busybox grep -v "^ro.product.locale."`"
logerror "###########################" ""

#### Set default backup name (with date)
if [ "$tz" == "phone" ]; then
	if [ "$backup_style" == "twrp" ]; then
		def_name=`busybox date +%Y-%m-%d--%H.%M.%S`
	else
		def_name=`busybox date +%Y-%m-%d.%H.%M.%S`
	fi
else
	if [ "$backup_style" == "twrp" ]; then
		def_name=`busybox date -u +%Y-%m-%d--%H.%M.%S`
	else
		def_name=`busybox date -u +%Y-%m-%d.%H.%M.%S`
	fi
fi

#### Set backup name to default if backup name was not provided
if [ ! "$name" ]; then
	name=$def_name
fi

#### Replace string with date if backup name contains the word "date"
if [ `busybox echo $name | busybox grep "date"` ]; then
	name=`busybox echo $name | busybox sed s/'date'/$def_name/g`
fi

#### Set all partitions to be specified if advanced backup mode is not selected
if [ ! "$adv" ]; then
	adv=$all_partitions
fi

#### Start timer
start_time=`busybox date +%s`

#### Check for root permissions
logmsg "Checking for root permissions..."
if [ "`busybox id -u`" == "0" ]; then
	logmsg "Root permissions acquired!"
else
	logmsg "Could not acquire root permissions! Exiting..."
	logerror "busybox id -u:" "`busybox id -u`"
	exit $err_noroot
fi

#### Analyse power status
logmsg "Analysing battery level..."
rem_power=-1
## Battery capacity
# Xperia Pro, Neo, Neo V, Arc, Arc S
if [ -f /sys/class/power_supply/bq27520/capacity ]; then
	rem_power=`busybox cat /sys/class/power_supply/bq27520/capacity`
fi
if [ -f /sys/class/power_supply/battery/capacity ]; then
	rem_power=`busybox cat /sys/class/power_supply/battery/capacity`
fi

## Charging state
if [ -f /sys/class/power_supply/ac/online ]; then
	if [ `busybox cat /sys/class/power_supply/ac/online` == "1" ]; then
		rem_power=100
	fi
fi
# HTC One X
if [ -f /sys/class/power_supply/battery/status ]; then
	if [ `busybox cat /sys/class/power_supply/battery/status` == "Charging" ]; then
		rem_power=100
	fi
fi

#### Check if power is sufficient
if [ $rem_power == -1 ]; then
	logmsg "Unable to check battery level! Taking a chance here..."
elif [ $rem_power -gt $req_power ]; then
	logmsg "Sufficient battery available!"
else
	logmsg "Sufficient battery not available! Exiting..."
	logerror "Battery Level:" "$rem_power"
	exit $err_nobatt
fi

#### Check BusyBox version (requires version 1.20 or above)
logmsg "Checking version of BusyBox installed..."
bb_major=`busybox | busybox grep "BusyBox v" | busybox awk '{print }' | busybox cut -d v -f 2 | busybox cut -d - -f 1 | busybox cut -d . -f 1`
bb_minor=`busybox | busybox grep "BusyBox v" | busybox awk '{print }' | busybox cut -d v -f 2 | busybox cut -d - -f 1 | busybox cut -d . -f 2`
if [ "`busybox echo $bb_major | busybox egrep "^[0-9]+$"`" -a "`busybox echo $bb_minor | busybox egrep "^[0-9]+$"`" ]; then
	if [ "$bb_major" -lt 1 -o "$bb_minor" -lt 20 ]; then
		logmsg "Error: BusyBox version less than 1.20 found. Exiting..."
		#exit $err_bbvless
	else
		logmsg "BusyBox version 1.20 or above installed!"
	fi
else
	logmsg "Unable to check BusyBox version. Taking chances here..."
fi

#### Set backup path according to the backup style
if [ "$backup_style" == "twrp" ]; then
	android_id=`busybox cat /proc/cmdline | busybox tr ' ' '\n' | busybox grep "androidboot.serialno=" | busybox tail -n 1 | busybox cut -d '=' -f 2`
	if [ ! "$android_id" ]; then
		android_id=`busybox cat /proc/cpuinfo | busybox grep "Serial" | busybox awk '{print $3}'`
	fi
	path="/TWRP/BACKUPS/$android_id"
else
	path="/clockworkmod/backup"
fi

#### Check if SD card is mounted
logmsg "Searching for SD card..."
# Use storage media / path if provided
if [ "$storage" != "" ] && [ -d $storage ]; then
	sdcard=$storage
	logmsg "Alternate storage media provided!"
	path=$sdcard$path
	blobsdir=$sdcard$blobsdir
else
	# Continue the search for an sd card
	sdcard="$EXTERNAL_STORAGE"
	if [ ! "$sdcard" ]; then
		sdcard="sdcard"
	fi
	sdcard=`busybox mount | busybox grep -v "/mnt/asec/" | busybox egrep -i "($sdcard|sdcard|external|storage).* type (vfat|fuse)" | busybox tail -n 1 | busybox cut -d ' ' -f 3`
	if [ ! "$sdcard" ]; then
		logmsg "SD card not found! Exiting..."
		logerror "Mounts:" "`busybox mount | busybox grep -v "/mnt/asec/"`"
		exit $err_nosdcard
	else
		logmsg "SD card found!"
		path=$sdcard$path
		blobsdir=$sdcard$blobsdir
	fi
fi

#### Detect partition layouts
part_type="not_found"
if [ -f "/proc/mtd" ]; then
	if [ "`busybox cat /proc/mtd | busybox egrep "(mtd|mmc|bml)"`" != "" ]; then
		part_type="/proc/mtd"
		part_path="/dev/mtd"
		part_bytediv=1048576
	else
		part_type="not_found"
	fi
fi
if [ -f "/proc/emmc" ]; then
	if [ "`busybox cat /proc/emmc | busybox egrep "(mtd|mmc|bml)"`" != "" ]; then
		part_type="/proc/emmc"
		part_path="/dev/block"
		part_bytediv=1048576
	else
		part_type="not_found"
	fi
fi
if [ -f "/system/partlayout4nandroid" ]; then
	if [ "`busybox cat /system/partlayout4nandroid | busybox egrep "(mtd|mmc|bml)"`" != "" ]; then
		part_type="/system/partlayout4nandroid"
		part_path="/dev/block"
		part_bytediv=1048576
	else
		part_type="not_found"
	fi
fi

#### Determine if default backup format is defined and follow the same
if [ -f $path/../.default_backup_format ]; then
	default_backup_format=`busybox cat $path/../.default_backup_format`
fi
if [ "$default_backup_format" == "dup" -a ! "$backup_style" ]; then
	backup_style="incremental"
	style_mode="default"
elif [ "$default_backup_format" == "tar" -a ! "$backup_style" ]; then
	backup_style="tarsplit"
	style_mode="default"
fi

#### Determine if advanced backup mode is defined and follow the same
if [ -f $path/../.advanced_backup_partitions ]; then
	default_adv=`busybox cat $path/../.advanced_backup_partitions`
fi
if [ "$default_adv" != "" -a "$advbkp_mode" != "run" ]; then
	adv=$default_adv
fi

#### Set filename extensions before setting backup style
img_ext="img"
as_name=".android_secure"

#### Announce backup style
if [ "$backup_style" == "incremental" ]; then
	if [ "$style_mode" == "default" ]; then
		logmsg "Incremental backup mode selected by default!"
	else
		logmsg "Incremental backup mode selected at run time!"
	fi
elif [ "$backup_style" == "tarsplit" ]; then
	if [ "$style_mode" == "default" ]; then
		logmsg "Split backup mode selected by default!"
	else
		logmsg "Split backup mode selected at run time!"
	fi
elif [ "$backup_style" == "twrp" ]; then
	as_name="and-sec"
	if [ "$part_path" == "/dev/mtd" ]; then
		img_ext="mtd.win"
	else
		img_ext="emmc.win"
	fi
	logmsg "TWRP backup mode selected at run time!"
fi
if [ "$advbkp_mode" == "run" ]; then
	logmsg "Advanced backup mode selected at run time!"
elif [ "$default_adv" != "" ]; then
	logmsg "Advanced backup mode selected by default!"
fi

#### Trap any exit/kill signals and cleanup before exiting
trap 'cleanup; killalltools; exit $err_killsig' 1 2 3 13 15

#### Mount /flexrom partition if it is hinted but not mouted (for Acer devices)
if [ ! "`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/flexrom "`" ]; then
	if [ -h /flexrom -o -e /flexrom ]; then
		if [ $part_type != "not_found" ]; then
			part_flexrom=`busybox cat $part_type | busybox grep "\"flexrom\"" | busybox cut -d ':' -f 1`
		fi
		if [ "$part_flexrom" ]; then
			flexrom_hinted=1
			busybox mount -o remount,rw /
			busybox mv -f /flexrom /flexrom_bkp
			busybox mkdir /flexrom
			busybox mount $part_path/$part_flexrom /flexrom
		fi
	fi
fi

#### Check for HP Touchpad (Originally on webOS, CM ported)
if [ "`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/dev/store/cm-system "`" ]; then
	is_hptouchpad="yes"	
else
	is_hptouchpad="no"
fi

#### Check if device has a yaffs2 file system
system_fs="`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "on /system " | busybox cut -d ' ' -f 5`"
data_fs="`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "on /data " | busybox cut -d ' ' -f 5`"
cache_fs="`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "on /cache " | busybox cut -d ' ' -f 5`"
datadata_fs="`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "on /datadata " | busybox cut -d ' ' -f 5`"
efs_fs="`busybox mount | busybox grep "on /efs " | busybox cut -d ' ' -f 5`"
preload_fs="`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "on /preload " | busybox cut -d ' ' -f 5`"
custbkp_fs="`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "on /.cust_backup " | busybox cut -d ' ' -f 5`"
flexrom_fs="`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "on /flexrom " | busybox cut -d ' ' -f 5`"
hptpboot_fs="`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "on /boot " | busybox cut -d ' ' -f 5`"

if [ "$system_fs" == "yaffs2" -o "$data_fs" == "yaffs2" -o "$cache_fs" == "yaffs2" -o "$datadata_fs" == "yaffs2" -o "$efs_fs" == "yaffs2" -o "$preload_fs" == "yaffs2" -o "$custbkp_fs" == "yaffs2" -o "$flexrom_fs" == "yaffs2" -o "$boot_fs" == "yaffs2" ]; then
	has_yaffs2="true"
fi

#### Check for required tools
logmsg "Checking for required tools..."
if [ "$has_yaffs2" == "true" -a "`busybox which mkyaffs2image`" == "" ]; then
	logmsg "Error: mkyaffs2image not found in path! Exiting..."
	exit $err_nomkyaffs
fi
if [ "$backup_style" == "incremental" -o "$backup_style" == "gc" ]; then
	if [ "`busybox which dedupe`" == "" ]; then
		logmsg "Error: dedupe not found in path! Exiting..."
		exit $err_nodedupe
	fi
fi
if [ "`busybox which busybox`" == "" ]; then
	logmsg "Error: busybox not found in path! Exiting..."
	exit $err_nobusybox
fi
logmsg "All required tools available!"

#### Create backup and blobs directories (if incremental backups selected)
if [ ! -d $path ]; then
	busybox mkdir -p $path
fi
if [ "$backup_style" == "incremental" -o "$backup_style" == "gc" ] && [ ! -d $blobsdir ]; then
	busybox mkdir -p $blobsdir
fi

#### Change to backup directory
cd $path
if [ $? != 0 ]; then
	logmsg "Error: Could not change to $path. Exiting..."
	exit $err_cntcdpath
fi

#### Create directory for backup & do the tests
if [ "$backup_style" != "gc" ]; then
	if [ ! -d $name ]; then
		busybox mkdir -p -- $name
		if [ ! -d $name ]; then
			logmsg "Error: Cannot create $name. Exiting..."
			logerror "Mounts:" "`busybox mount | busybox grep -v "/mnt/asec/"`"
			exit $err_cntmkname
		fi
	else
		if [ "$replace_backup" == "yes" ]; then
			logmsg "Replace backup mode selected at run time!"
		else
			logmsg "Error: $name already exists!"
			logmsg "Do you want to replace? [y|n]: \c"
			read answer
			if [ "$answer" == "y" -o "$answer" == "Y" -o "$answer" == "yes" -o "$answer" == "Yes" -o "$answer" == "YES" ]; then
				logmsg "Replace backup mode selected upon prompt!"
			else
				logmsg "Error: $name already exists! Exiting..."
				exit $err_nameexist
			fi
		fi
	fi
	busybox touch -- $name/.nandroidwritable
	if [ ! -e $name/.nandroidwritable ]; then
		logmsg "Error: Cannot write to $name ! Exiting..."
		logerror "Mounts:" "`busybox mount | busybox grep -v "/mnt/asec/"`"
		exit $err_cntwrname
	fi
	busybox rm -- $name/.nandroidwritable
fi
if [ "$backup_style" == "incremental" ]; then
	busybox touch -- $blobsdir/.nandroidwritable
	if [ ! -e $blobsdir/.nandroidwritable ]; then
		logmsg "Error: Cannot write to $blobsdir ! Exiting..."
		logerror "Mounts:" "`busybox mount | busybox grep -v "/mnt/asec/"`"
		exit $err_cntwrblobs
	fi
	busybox rm -- $blobsdir/.nandroidwritable
	if [ ! -f $blobsdir/.nomedia ]; then
		busybox touch $blobsdir/.nomedia
	fi
fi

#### Garbage Collect (without backup)
if [ "$backup_style" == "gc" ]; then
	logmsg "Garbage Collection mode selected!"
	garbagecollect
	# End timer
	end_time=`busybox date +%s`
	elapsed=`busybox expr $end_time - $start_time`
	# Calculate elapsed time and Announce
	e_min=`busybox expr $elapsed / 60`
	e_sec=`busybox expr $e_min \* 60`
	e_sec=`busybox expr $elapsed - $e_sec`
	logmsg "Garbage Collection Completed in $e_min minutes $e_sec seconds!"
	exit 0
fi

#### Detect /boot, /recovery, /wimax and /appslog partitions
if [ $part_type != "not_found" ]; then
	part_boot=`busybox cat $part_type | busybox grep "\"boot\"" | busybox cut -d ':' -f 1`
	part_recovery=`busybox cat $part_type | busybox grep "\"recovery\"" | busybox cut -d ':' -f 1`
	part_wimax=`busybox cat $part_type | busybox grep "\"wimax\"" | busybox cut -d ':' -f 1`
	part_appslog=`busybox cat $part_type | busybox grep "\"appslog\"" | busybox cut -d ':' -f 1`
fi

#### Disk space check (in MB)
logmsg "Checking disk space..."

#### /mmcblk0_start partition size (for Acer devices)
if [ "$flexrom_fs" == "" -o "`busybox echo $adv | busybox grep 'm'`" == "" ]; then
	u_mmcblk0_start=0
else
	mmcblk0_start_dec=13312
	mmcblk0_start_count=`busybox expr $mmcblk0_start_dec \* 512`
	u_mmcblk0_start=7
	mmcblk0_start_start=0
fi

#### /boot partition size
if [ "$part_type" == "not_found" -o "$part_boot" == "" -o "`busybox echo $adv | busybox grep 'b'`" == "" -o "$custbkp_fs" != "" -o "$is_hptouchpad" == "yes" ]; then
	u_boot=0
else
	boot_hex=`busybox cat $part_type | busybox grep "\"boot\"" | busybox cut -d ' ' -f 2`
	boot_dec=`busybox printf "%d \n " 0x$boot_hex`
	boot_count=`busybox expr $boot_dec \* 1024`
	u_boot=`busybox expr $boot_dec / $part_bytediv`
	u_boot=`busybox expr $u_boot + 1`
	if [ "`busybox cat $part_type | busybox grep "\"boot\"" | busybox cut -d ' ' -f 5`" != "" ]; then
		boot_start_hex=`busybox cat $part_type | busybox grep "\"boot\"" | busybox cut -d ' ' -f 5`
		boot_start=`busybox printf "%d \n " 0x$boot_start_hex`
		boot_start=`busybox expr $boot_start \* 1024`
	fi
fi

#### /recovery partition size
if [ "$part_type" == "not_found" -o "$part_recovery" == "" -o "`busybox echo $adv | busybox grep 'r'`" == "" ]; then
	u_recovery=0
else
	recovery_hex=`busybox cat $part_type | busybox grep "\"recovery\"" | busybox cut -d ' ' -f 2`
	recovery_dec=`busybox printf "%d \n " 0x$recovery_hex`
	recovery_count=`busybox expr $recovery_dec \* 1024`
	u_recovery=`busybox expr $recovery_dec / $part_bytediv`
	u_recovery=`busybox expr $u_recovery + 1`
	if [ "`busybox cat $part_type | busybox grep "\"recovery\"" | busybox cut -d ' ' -f 5`" != "" ]; then
		recovery_start_hex=`busybox cat $part_type | busybox grep "\"recovery\"" | busybox cut -d ' ' -f 5`
		recovery_start=`busybox printf "%d \n " 0x$recovery_start_hex`
		recovery_start=`busybox expr $recovery_start \* 1024`
	fi
fi

#### /wimax partition size (for Samsung devices)
if [ "$part_type" == "not_found" -o "$part_wimax" == "" -o "`busybox echo $adv | busybox grep 'w'`" == "" ]; then
	u_wimax=0
else
	wimax_hex=`busybox cat $part_type | busybox grep "\"wimax\"" | busybox cut -d ' ' -f 2`
	wimax_dec=`busybox printf "%d \n " 0x$wimax_hex`
	wimax_count=`busybox expr $wimax_dec \* 1024`
	u_wimax=`busybox expr $wimax_dec / $part_bytediv`
	u_wimax=`busybox expr $u_wimax + 1`
	if [ "`busybox cat $part_type | busybox grep "\"wimax\"" | busybox cut -d ' ' -f 5`" != "" ]; then
		wimax_start_hex=`busybox cat $part_type | busybox grep "\"wimax\"" | busybox cut -d ' ' -f 5`
		wimax_start=`busybox printf "%d \n " 0x$wimax_start_hex`
		wimax_start=`busybox expr $wimax_start \* 1024`
	fi
fi

#### /appslog partition size (for HTC and Sony (Erricsson) devices)
if [ "$part_type" == "not_found" -o "$part_appslog" == "" -o "`busybox echo $adv | busybox grep 'l'`" == "" ]; then
	u_appslog=0
else
	appslog_hex=`busybox cat $part_type | busybox grep "\"appslog\"" | busybox cut -d ' ' -f 2`
	appslog_dec=`busybox printf "%d \n " 0x$appslog_hex`
	appslog_count=`busybox expr $appslog_dec \* 1024`
	u_appslog=`busybox expr $appslog_dec / $part_bytediv`
	u_appslog=`busybox expr $u_appslog + 1`
	if [ "`busybox cat $part_type | busybox grep "\"appslog\"" | busybox cut -d ' ' -f 5`" != "" ]; then
		appslog_start_hex=`busybox cat $part_type | busybox grep "\"appslog\"" | busybox cut -d ' ' -f 5`
		appslog_start=`busybox printf "%d \n " 0x$appslog_start_hex`
		appslog_start=`busybox expr $appslog_start \* 1024`
	fi
fi

#### /system partition size
if [ "$system_fs" == "" -o "`busybox echo $adv | busybox grep 's'`" == "" ]; then
	u_system=0
else
	u_system=`busybox df -Pm /system | busybox tail -n 1 | busybox awk '{print $3}'`
	u_system=`busybox expr $u_system + 1`
fi

#### /data partition size
if [ "$data_fs" == "" -o "`busybox echo $adv | busybox grep 'd'`" == "" ]; then
	u_data=0
else
	u_data=`busybox df -Pm /data | busybox tail -n 1 | busybox awk '{print $3}'`
	u_data=`busybox expr $u_data + 1`
	if [ -d /data/media ]; then
		u_datamedia=`busybox du -sm /data/media | busybox awk '{print $1}'`
		u_data=`busybox expr $u_data - $u_datamedia`
		if [ $u_data -lt 10 ]; then
			u_data=10
		fi
	fi
fi

#### /cache partition size
if [ "$cache_fs" == "" -o "`busybox echo $adv | busybox grep 'c'`" == "" ]; then
	u_cache=0
else
	u_cache=`busybox df -Pm /cache | busybox tail -n 1 | busybox awk '{print $3}'`
	u_cache=`busybox expr $u_cache + 1`
fi

#### /datadata partition size (for some Samsung devices)
if [ "$datadata_fs" == "" -o "`busybox echo $adv | busybox grep 't'`" == "" ]; then
	u_datadata=0
else
	u_datadata=`busybox df -Pm /datadata | busybox tail -n 1 | busybox awk '{print $3}'`
	u_datadata=`busybox expr $u_datadata + 1`
fi

#### /efs partition size (for Samsung devices)
if [ "$efs_fs" == "" -o "`busybox echo $adv | busybox grep 'e'`" == "" ]; then
	u_efs=0
else
	u_efs=`busybox df -Pm /efs | busybox tail -n 1 | busybox awk '{print $3}'`
	u_efs=`busybox expr $u_efs + 1`
fi

#### /preload partition size (for Samsung devices)
if [ "$preload_fs" == "" -o "`busybox echo $adv | busybox grep 'o'`" == "" ]; then
	u_preload=0
else
	u_preload=`busybox df -Pm /preload | busybox tail -n 1 | busybox awk '{print $3}'`
	u_preload=`busybox expr $u_preload + 1`
fi

#### /.cust_backup partition size (for Huawei devices)
if [ "$custbkp_fs" == "" -o "`busybox echo $adv | busybox grep 'u'`" == "" ]; then
	u_custbkp=0
else
	u_custbkp=`busybox df -Pm /.cust_backup | busybox tail -n 1 | busybox awk '{print $3}'`
	u_custbkp=`busybox expr $u_custbkp + 1`
fi

#### /flexrom partition size (for Acer devices)
if [ "$flexrom_fs" == "" -o "`busybox echo $adv | busybox grep 'f'`" == "" ]; then
	u_flexrom=0
else
	u_flexrom=`busybox df -Pm /flexrom | busybox tail -n 1 | busybox awk '{print $3}'`
	u_flexrom=`busybox expr $u_flexrom + 1`
fi

### /boot partition size (for HP Touchpad)
if [ "$is_hptouchpad" == "no" -o "`busybox echo $adv | busybox grep 'p'`" == "" ]; then
	u_hptpboot=0
else
	u_hptpboot=`busybox df -Pm /boot | busybox tail -n 1 | busybox awk '{print $3}'`
	u_hptpboot=`busybox expr $u_hptpboot + 1`
fi

#### Check if .android_secure exists
as_parent="`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/.android_secure " | busybox cut -d ' ' -f 3 | busybox sed s/'\/.android_secure'/''/g`"

#### Finding .android_secure the traditional way (since some devices does not hint)
if [ ! "$as_parent" ]; then
	# The traditional sdcard detection
	as_sdcards="$EXTERNAL_STORAGE"
	as_sdcards=`busybox mount | busybox grep -v "/mnt/asec/" | busybox egrep "($as_sdcards|sdcard).* type (vfat|fuse)" | busybox cut -d ' ' -f 3`
	# If a storage media is defined manually, check it too
	if [ "$storage" != "" ] && [ -d $storage ]; then
		as_sdcards="$as_sdcards $storage"
	fi
	# Run through sdcards to find where is .android_secure
	for as_sdcard in $as_sdcards; do
		if [ -d $as_sdcard/.android_secure ]; then
			as_parent=$as_sdcard
		fi
	done
fi

#### .android_secure partition size
if [ "$as_parent" == "" -o "`busybox echo $adv | busybox grep 'a'`" == "" ]; then
	u_as=0
else
	# Mount sdcard into a temporary location for accessing .android_secure partition
	busybox mount -o remount,rw /
	busybox mkdir -p $sdcard_temp_mount
	busybox mount $as_parent $sdcard_temp_mount
	cd $sdcard_temp_mount
	u_as=`busybox du -sm .android_secure | busybox awk '{print $1}'`
	u_as=`busybox expr $u_as + 1`
fi

#### sd-ext partition size
# Check if sd-ext is mounted
if [ ! "$sdextdir" ]; then
	sdextdir="$SD_EXT_DIRECTORY"
	if [ ! "$sdextdir" ]; then
		sdextdir="/sd-ext"
	fi
	sdext_mount=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep -v "sdhci" | busybox egrep "($sdextdir|sd|ext).* type ext[234]" | busybox tail -n 1`
else
	sdext_mount=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep -v "sdhci" | busybox egrep "$sdextdir type" | busybox tail -n 1`
fi
if [ "$sdext_mount" == "" -o "`busybox echo $adv | busybox grep 'x'`" == "" ]; then
	u_sdext=0
else
	sdext_fs=`busybox echo $sdext_mount | busybox cut -d ' ' -f 5`
	extm=`busybox echo $sdext_mount | busybox cut -d ' ' -f 3`
	u_sdext=`busybox df -Pm $extm | busybox tail -n 1 | busybox awk '{print $3}'`
	u_sdext=`busybox expr $u_sdext + 1`
fi

#### Required space calculation
req_space=`busybox expr $u_mmcblk0_start + $u_boot + $u_recovery + $u_wimax + $u_appslog + $u_system + $u_data + $u_cache + $u_datadata + $u_efs + $u_preload + $u_custbkp + $u_flexrom + $u_hptpboot + $u_as + $u_sdext`

#### Available space calculation
freespace=`busybox df -Pm $sdcard | busybox tail -n 1 | busybox awk '{print $4}'`

#### Announce available space and required space
logmsg "SD Card Free Space: $freespace MB"
logmsg "Required Space: $req_space MB"
if [ $freespace -lt $req_space ]; then
	cd $path
	if [ $? != 0 ]; then
		logmsg "Error: Could not change to $path. Exiting..."
		exit $err_cntcdpath
	fi
	busybox rm -rf -- $name
	logmsg "Not enough disk space! Exiting..."
	logerror "df:" "`busybox df -Pm`"
	logerror "Partitions:" "`busybox cat $part_type`"
	logerror ".android_secure:" "$u_as"
	logerror "sd-ext:" "$u_sdext"
	cleanup
	exit $err_nospace
else
	logmsg "Necessary disk space available!"
fi

#### Detect and fill up excludes
logmsg "Detecting mountpoints to exclude..."

# /system excludes
if [ "$system_fs" != "" -a "`busybox echo $adv | busybox grep 's'`" != "" ]; then
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/system/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\/'/''/g`
	for mount in $mounts; do
		system_excludes="$system_excludes --exclude=$mount/*"
	done
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/system/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\\/system'/''/g | busybox sed s/'\\/'/'\\\\\/'/g | busybox sed s/'$'/'\\\\\/*'/g | busybox sed s/'^'/'\\\\\.'/g`
	cd /system
	for mount in $mounts; do
		system_excludes_dedupe="$system_excludes_dedupe `busybox find -path $mount`"
	done
fi

# /data excludes
if [ "$data_fs" != "" -a "`busybox echo $adv | busybox grep 'd'`" != "" ]; then
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/data/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\/'/''/g`
	for mount in $mounts; do
		data_excludes="$data_excludes --exclude=$mount/*"
	done
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/data/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\\/data'/''/g | busybox sed s/'\\/'/'\\\\\/'/g | busybox sed s/'$'/'\\\\\/*'/g | busybox sed s/'^'/'\\\\\.'/g`
	cd /data
	for mount in $mounts; do
		data_excludes_dedupe="$data_excludes_dedupe `busybox find -path $mount`"
	done
fi

# /cache excludes
if [ "$cache_fs" != "" -a "`busybox echo $adv | busybox grep 'c'`" != "" ]; then
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/cache/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\/'/''/g`
	for mount in $mounts; do
		cache_excludes="$cache_excludes --exclude=$mount/*"
	done
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/cache/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\\/cache'/''/g | busybox sed s/'\\/'/'\\\\\/'/g | busybox sed s/'$'/'\\\\\/*'/g | busybox sed s/'^'/'\\\\\.'/g`
	cd /cache
	for mount in $mounts; do
		cache_excludes_dedupe="$cache_excludes_dedupe `busybox find -path $mount`"
	done
fi

# /datadata excludes (for some Samsung devices)
if [ "$datadata_fs" != "" -a "`busybox echo $adv | busybox grep 't'`" != "" ]; then
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/datadata/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\/'/''/g`
	for mount in $mounts; do
		datadata_excludes="$datadata_excludes --exclude=$mount/*"
	done
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/datadata/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\\/datadata'/''/g | busybox sed s/'\\/'/'\\\\\/'/g | busybox sed s/'$'/'\\\\\/*'/g | busybox sed s/'^'/'\\\\\.'/g`
	cd /datadata
	for mount in $mounts; do
		datadata_excludes_dedupe="$datadata_excludes_dedupe `busybox find -path $mount`"
	done
fi

# /efs excludes (for Samsung devices)
if [ "$efs_fs" != "" -a "`busybox echo $adv | busybox grep 'e'`" != "" ]; then
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/efs/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\/'/''/g`
	for mount in $mounts; do
		efs_excludes="$efs_excludes --exclude=$mount/*"
	done
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/efs/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\\/efs'/''/g | busybox sed s/'\\/'/'\\\\\/'/g | busybox sed s/'$'/'\\\\\/*'/g | busybox sed s/'^'/'\\\\\.'/g`
	cd /efs
	for mount in $mounts; do
		efs_excludes_dedupe="$efs_excludes_dedupe `busybox find -path $mount`"
	done
fi

# /preload excludes (for Samsung devices)
if [ "$preload_fs" != "" -a "`busybox echo $adv | busybox grep 'o'`" != "" ]; then
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/preload/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\/'/''/g`
	for mount in $mounts; do
		preload_excludes="$preload_excludes --exclude=$mount/*"
	done
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/preload/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\\/preload'/''/g | busybox sed s/'\\/'/'\\\\\/'/g | busybox sed s/'$'/'\\\\\/*'/g | busybox sed s/'^'/'\\\\\.'/g`
	cd /preload
	for mount in $mounts; do
		preload_excludes_dedupe="$preload_excludes_dedupe `busybox find -path $mount`"
	done
fi

# /.cust_backup excludes (for Huawei devices)
if [ "$custbkp_fs" != "" -a "`busybox echo $adv | busybox grep 'u'`" != "" ]; then
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/.cust_backup/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\/'/''/g`
	for mount in $mounts; do
		custbkp_excludes="$custbkp_excludes --exclude=$mount/*"
	done
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/.cust_backup/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\\/.cust_backup'/''/g | busybox sed s/'\\/'/'\\\\\/'/g | busybox sed s/'$'/'\\\\\/*'/g | busybox sed s/'^'/'\\\\\.'/g`
	cd /.cust_backup
	for mount in $mounts; do
		custbkp_excludes_dedupe="$custbkp_excludes_dedupe `busybox find -path $mount`"
	done
fi

# /flexrom excludes (for Acer devices)
if [ "$flexrom_fs" != "" -a "`busybox echo $adv | busybox grep 'f'`" != "" ]; then
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/flexrom/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\/'/''/g`
	for mount in $mounts; do
		flexrom_excludes="$flexrom_excludes --exclude=$mount/*"
	done
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/flexrom/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\\/flexrom'/''/g | busybox sed s/'\\/'/'\\\\\/'/g | busybox sed s/'$'/'\\\\\/*'/g | busybox sed s/'^'/'\\\\\.'/g`
	cd /flexrom
	for mount in $mounts; do
		flexrom_excludes_dedupe="$flexrom_excludes_dedupe `busybox find -path $mount`"
	done
fi

# /boot excludes (for HP Touchpad)
if [ "$is_hptouchpad" != "no" -a "`busybox echo $adv | busybox grep 'p'`" != "" ]; then
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/boot/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\/'/''/g`
	for mount in $mounts; do
		hptpboot_excludes="$hptpboot_excludes --exclude=$mount/*"
	done
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "/boot/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\\/boot'/''/g | busybox sed s/'\\/'/'\\\\\/'/g | busybox sed s/'$'/'\\\\\/*'/g | busybox sed s/'^'/'\\\\\.'/g`
	cd /boot
	for mount in $mounts; do
		hptpboot_excludes_dedupe="$hptpboot_excludes_dedupe `busybox find -path $mount`"
	done
fi

# sd-ext excludes
if [ "$sdext_mount" != "" -a "`busybox echo $adv | busybox grep 'x'`" != "" ]; then
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "$extm/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\/'/''/g`
	for mount in $mounts; do
		sdext_excludes="$sdext_excludes --exclude=$mount/*"
	done
	mounts=`busybox mount | busybox grep -v "/mnt/asec/" | busybox grep "$extm/" | busybox cut -d ' ' -f 3 | busybox sed s/'^\$extm'/''/g | busybox sed s/'\\/'/'\\\\\/'/g | busybox sed s/'$'/'\\\\\/*'/g | busybox sed s/'^'/'\\\\\.'/g`
	cd $extm
	for mount in $mounts; do
		sdext_excludes_dedupe="$sdext_excludes_dedupe `busybox find -path $mount`"
	done
fi

logmsg "Backing up to $path/$name"

#### Change to backup directory
cd -- $path/$name

#### Backup mmcblk0_start (for Acer devices)
if [ "$flexrom_fs" ]; then
	nandroid_dd "mmcblk0_start" "mmcblk0_start" "mmcblk0" "m" "$u_mmcblk0_start" "512" "$mmcblk0_start_count" "$mmcblk0_start_start" "no"
fi

#### Backup boot
if [ "$is_hptouchpad" != "yes" -a "$custbkp_fs" == "" ]; then
	nandroid_dd "boot" "boot" "$part_boot" "b" "$u_boot" "4096" "$boot_count" "$boot_start" "yes"
fi

#### Notice to install patch file, if boot partition is not found.
if [ $part_type == "not_found" -o "$part_boot" == "" ]; then
	logmsg "Consider installing patch file for your device, for a complete nandroid!"
fi

#### Backup recovery
nandroid_dd "recovery" "recovery" "$part_recovery" "r" "$u_recovery" "4096" "$recovery_count" "$recovery_start" "yes"

#### Backup wimax (for Samsung devices)
nandroid_dd "wimax" "wimax" "$part_wimax" "w" "$u_wimax" "4096" "$wimax_count" "$wimax_start" "no"

#### Backup appslog (for HTC and Sony (Ericsson) devices)
nandroid_dd "appslog" "appslog" "$part_appslog" "l" "$u_appslog" "4096" "$appslog_count" "$appslog_start" "no"

#### Backup /system
nandroid_fs "system" "system" "s" "/system" "system" "$system_fs" "$u_system" "$system_excludes" "$system_excludes_dedupe" "yes"

#### Backup /data
nandroid_fs "data" "data" "d" "/data" "data" "$data_fs" "$u_data" "--exclude=data/media $data_excludes" "./media $data_excludes_dedupe" "yes"

#### Backup /cache
nandroid_fs "cache" "cache" "c" "/cache" "cache" "$cache_fs" "$u_cache" "$cache_excludes" "$cache_excludes_dedupe" "yes"

#### Backup /datadata (for some Samsung devices)
nandroid_fs "datadata" "datadata" "t" "/datadata" "datadata" "$datadata_fs" "$u_datadata" "$datadata_excludes" "$datadata_excludes_dedupe" "no"

#### Backup /efs (for Samsung devices)
nandroid_fs "efs" "efs" "e" "/efs" "efs" "$efs_fs" "$u_efs" "$efs_excludes" "$efs_excludes_dedupe" "no"

#### Backup /preload (for Samsung devices)
nandroid_fs "preload" "preload" "o" "/preload" "preload" "$preload_fs" "$u_preload" "$preload_excludes" "$preload_excludes_dedupe" "no"

#### Backup /.cust_backup partition (for Huawei devices)
if [ "$custbkp_fs" != "" -a "`echo $adv | busybox grep 'u'`" != "" ]; then
	busybox mount -o remount,rw /
	busybox mkdir -p $custbkp_temp_mount/boot
	busybox mount /.cust_backup $custbkp_temp_mount/boot
	nandroid_fs ".cust_backup" "boot" "u" "$custbkp_temp_mount/boot" "boot" "$custbkp_fs" "$u_custbkp" "$custbkp_excludes" "$custbkp_excludes_dedupe" "no"
fi

#### Backup /flexrom partition (for Acer devices)
nandroid_fs "flexrom" "flexrom" "f" "/flexrom" "flexrom" "$flexrom_fs" "$u_flexrom" "$flexrom_excludes" "$flexrom_excludes_dedupe" "no"

#### Backup /boot partition (for HP Touchpad)
if [ "$is_hptouchpad" == "yes" -a "$hptpboot_fs" != "" ]; then
	nandroid_fs "boot" "boot" "p" "/boot" "boot" "$hptpboot_fs" "$u_hptpboot" "$hptpboot_excludes" "$hptpboot_excludes_dedupe" "no"
fi

#### Backup .android_secure
if [ "$as_parent" ]; then
	nandroid_fs ".android_secure" "$as_name" "a" "$sdcard_temp_mount/.android_secure" ".android_secure" "vfat" "$u_as" "" "" "no"
fi

#### Backup sd-ext
if [ "$sdext_mount" != "" -a "`echo $adv | busybox grep 'x'`" != "" ]; then
	busybox mount -o remount,rw /
	busybox mkdir -p $sdext_temp_mount/sd-ext
	busybox mount $extm $sdext_temp_mount/sd-ext
	cd $sdext_temp_mount
	nandroid_fs "sd-ext" "sd-ext" "x" "$sdext_temp_mount/sd-ext" "sd-ext" "$sdext_fs" "$u_sdext" "$sdext_excludes" "$sdext_excludes_dedupe" "no"
fi

#### Sync data to disk, sleep for a while and cleanup
busybox sync
busybox sleep 2
cleanup

#### Get ready to generate md5
cd $path/$name
if [ $? != 0 ]; then
	logmsg "Error: Could not change to $path/$name. Exiting..."
	exit $err_cntcdpath
fi
if [ -f onandroid.log ]; then
	busybox rm onandroid.log
fi

#### Generate md5
if [ "$backup_style" == "twrp" -a "$generate_md5" != "no" ]; then
	files=`busybox ls -lA1 | busybox awk '{print $7}' | busybox grep -v ".md5"`
	for file in $files; do
		logmsg "Generating md5sum for $file...\c"
		busybox md5sum $file > $file.md5 2> /dev/null &
		while [ ` busybox ps | busybox grep "busybox md5sum" | busybox grep -v "busybox grep busybox md5sum" | busybox awk '{print $1}'` ]; do
			progress md5sum_generate
			busybox sleep 2
		done
		busybox sleep 1
		while [ `busybox stat -t $file.md5 | busybox awk '{print $2}'` == "0" ]; do
			progress md5sum_validate
			busybox sleep 2
		done
		progress_done
		busybox echo ""
	done
elif [ "$backup_style" == "twrp" ]; then
	null="null"
else
	logmsg "Generating md5sum...\c"
	if [ -f nandroid.md5 ]; then
		busybox rm nandroid.md5
	fi
	busybox md5sum .* * > nandroid.md5 2> /dev/null &
	while [ `busybox ps | busybox grep "busybox md5sum" | busybox grep -v "busybox grep busybox md5sum" | busybox awk '{print $1}'` ]; do
		progress md5sum_generate
		busybox sleep 2
	done
	progress_done
	busybox echo ""
 	# Verify md5sum (to check if the file is populated)
	if [ "`busybox ls -A`" != "nandroid.md5" ]; then
		logmsg "Verifying md5sum...\c"
		while [ `busybox stat -t nandroid.md5 | busybox awk '{print $2}'` == "0" ]; do
			progress md5sum_validate
			busybox sleep 2
		done
		progress_done
		busybox echo ""
	fi
fi

#### Sync-up and wait a second for things to settle
busybox sync
busybox sleep 1

#### End timer
end_time=`busybox date +%s`
elapsed=`busybox expr $end_time - $start_time`

#### Calculate elapsed time and Announce
e_min=`busybox expr $elapsed / 60`
e_sec=`busybox expr $e_min \* 60`
e_sec=`busybox expr $elapsed - $e_sec`
logmsg "Online Nandroid Backup Completed in $e_min minutes $e_sec seconds!"
logerror "###########################" ""
bkp_files=`busybox ls -l1A $path/$name`
logerror "Files Backed-up:" "\"$bkp_files\""
busybox cp $logfile .

#### LED detection
# Xperia Pro
if [ -f /sys/class/leds/green/brightness ]; then
	led="/sys/class/leds/green/brightness"
# Xperia U
elif [ -f /sys/class/leds/m-key-green/brightness ]; then
	led="/sys/class/leds/m-key-green/brightness"
else
	led="none"
fi

#### Vibrator detection
# Xperia Pro
if [ -f /sys/class/timed_output/vibrator/enable ]; then
	vibrator="/sys/class/timed_output/vibrator/enable"
else
	vibrator="none"
fi

#### LED / Vibrate Notification
if [ "$notif_disable" != "yes" ] ; then
	if [ "$vibrator" == "none" -a "$led" == "none" ] ; then
		exit 0
	else
		if [ $vibrator != "none" ]; then
			busybox echo 250 > $vibrator
		fi
		if [ $led != "none" ]; then
			busybox echo 255 > $led
		fi
		busybox sleep 0.5
		if [ $vibrator != "none" ]; then
			busybox echo 0 > $vibrator
		fi
		if [ $led != "none" ]; then
			busybox echo 0 > $led
		fi
		busybox sleep 0.2
		if [ $vibrator != "none" ]; then
			busybox echo 250 > $vibrator
		fi
		if [ $led != "none" ]; then
			busybox echo 255 > $led
		fi
		busybox sleep 0.5
		if [ $vibrator != "none" ]; then
			busybox echo 0 > $vibrator
		fi
		if [ $led != "none" ]; then
			busybox echo 0 > $led
		fi
	fi
fi

exit 0
